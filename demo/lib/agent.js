// lib

function LSTMCell() {
  this.num_units = 8;
  this.input_size = 2;
  this.factor = 10000.0;
  this.batch_size = 5;
  this.Wfull = nj.array([[3362,8502,27660,22609,23286,-16748,18228,9478,-15369,4111,-9538,16326,10152,-21173,14521,12753,-325,-9546,14797,7955,13325,-7627,8864,3013,-14483,-5626,-6018,-9261,-12692,13724,-37009,-11038],[-731,-17811,-9242,-17709,16792,5828,7409,3230,1610,-24336,3852,3869,-16760,6537,20973,16956,-20196,-17739,-9920,-29052,-14952,-6089,27456,-1992,-6476,2816,-5925,1315,5896,-15373,-502,-2554],[6348,9102,1338,5964,15923,20627,13324,23695,-8388,-27934,-1974,6682,3411,-4107,17825,-11275,-9356,-11938,-9028,-19654,-21020,5789,16787,-4936,9301,-9109,11881,-29,-4257,-4664,-6480,-7079],[-27426,-7635,-3121,-13281,9822,4282,9078,-8103,13467,24415,-6487,2278,-12697,9480,3515,-13827,-24395,20104,14038,7220,10430,20584,-10646,10239,1984,5739,1308,4036,-6006,5663,-9875,24970],[-15653,8248,-13151,25777,482,16886,8899,17302,-6217,907,-2799,15289,-6664,998,12608,14080,12749,-4578,4576,-20818,-2658,-8266,-13295,-4051,777,-1286,-10539,-6204,19957,6420,1487,-3156],[-2101,3505,11520,3284,8640,1713,-11104,-15331,-10229,7284,5735,-1121,-26578,-10308,-14044,10187,-3511,2883,-7880,-639,-12183,-5430,-5311,-4837,16615,-4793,5424,18686,-16320,374,10343,-141],[-15601,12831,3429,3560,10522,-10913,593,-9105,16795,11116,6791,940,21925,-16093,-1031,-3659,-7082,-2672,-10059,4940,35873,15095,-7876,-11270,2685,-15134,17533,12515,-1329,23102,-9402,1815],[2123,1718,-926,-15089,9668,182,-14826,12111,7721,-6568,4510,-10952,4587,-11395,14735,16769,9833,5049,-4509,19414,12580,10683,2534,14198,-10328,-3386,-5254,-11174,-17340,6809,-2907,-4205],[425,-6543,-9641,-2314,-1077,-8192,-1612,25988,5964,-13068,-10875,-14265,-4573,-11749,6427,-24,4078,3967,312,6351,-16986,-12004,-11629,16496,3410,3577,-33005,-7962,2304,1871,17125,-2175],[27907,7782,3748,3564,-2509,-6021,-4722,6993,-727,-17231,-907,24088,-5921,-1638,24356,10388,-8548,741,-6937,3600,4379,12331,3457,10167,19213,10193,10992,-8904,9531,-4300,14109,4557]]);
  this.bias = nj.array([-25647,32179,-10164,-1989,-6353,-1543,4095,29831,-22306,-8921,-4708,-15233,9220,3406,-12551,13583,-12050,-71741,1122,-44587,2864,-6563,-6136,48814,-5187,10247,-8001,33678,10477,10243,38347,28668]);
  this.Wfull = nj.divide(this.Wfull, this.factor);
  this.bias = nj.divide(this.bias, this.factor);
}
LSTMCell.prototype.zero_state = function() {
  return [nj.zeros([this.batch_size, this.num_units]), nj.zeros([this.batch_size, this.num_units])];
};
LSTMCell.prototype.forward = function(x, h, c) {
  var concat = nj.concatenate([x, h]);
  var hidden = nj.add(nj.dot(concat, this.Wfull), nj.stack([this.bias, this.bias, this.bias, this.bias, this.bias]));
  var num_units = this.num_units;
  var forget_bias = this.forget_bias;

  var i=nj.sigmoid(hidden.T.slice([0*num_units, 1*num_units])).T;
  var f=nj.sigmoid(hidden.T.slice([1*num_units, 2*num_units])).T;
  var g=nj.tanh(hidden.T.slice([2*num_units, 3*num_units])).T;
  var o=nj.sigmoid(hidden.T.slice([3*num_units, 4*num_units])).T;

  var new_c = nj.add(nj.multiply(c, f), nj.multiply(g, i));
  var new_h = nj.multiply(nj.tanh(new_c), o);

  return [new_h, new_c];
};

function CartpoleSwingupModel() {
  this.lstm = new LSTMCell();
  this.factor = this.lstm.factor;

  this.proj_k_weight=nj.array([[6126,2565,-12242,-1414,-8369,-17916,-10688,10351,8752,4846,9483,7420,-976,-15079,5845,-187,620,-5726,9856,-16941,-20979,7407,21906,9467,-1460,4659,-4204,731,5961,463,-19534,9883],[574,5736,17782,-9919,-593,-9839,-5246,8078,-12205,7260,-14617,19270,-321,10644,-33670,-7823,-12704,1675,7616,12313,-2257,-19381,-1617,-5428,19209,6459,-3156,1842,-12196,8966,7188,-4424],[1977,-10296,-11665,2051,-14191,517,2241,-4192,-4316,8657,-453,11515,7378,13395,21630,-469,-32277,-22121,-8992,15950,6803,3815,8295,3014,12473,-179,-1719,-2503,8461,-8519,-27478,-9598],[-1773,-7431,-272,4218,284,10988,-5477,5430,9015,-227,14399,-857,-955,13294,6170,-4507,4569,-14779,-8953,5569,9716,4633,10012,-6660,-16428,2993,-922,22069,-7914,-10448,-2219,-6845],[-1513,-6580,-17728,8258,10713,-25869,-2138,-957,13269,-7387,-11298,-376,-19680,10193,5497,1239,16712,20553,13015,-14464,-9232,8063,8811,6875,6049,6322,387,13468,2461,6492,-5223,1260],[-1509,2768,-23649,1116,16722,104,-22496,6716,-9281,-1917,-14880,2137,-6217,-7437,-19519,-5403,12035,-1171,-1928,7729,-17729,-14009,13153,-599,12245,-3707,11665,-21488,-2290,5417,3207,8122],[9548,-10308,6933,13522,-16435,-12259,15233,-7436,-10089,-2589,-25009,1132,6181,-19367,-25237,1973,-10045,228,-10474,20879,-13931,-11333,15985,3782,5179,5711,19875,17278,13559,75,-6100,11716],[-6681,21982,-31780,-14642,-16123,-744,19814,14445,-816,-2538,6683,-9052,16481,25937,-10467,-980,-14882,-17658,-22193,-7291,-588,-2863,11240,8474,1174,-282,18142,-2664,-8895,-12773,-16791,8388]]);
  this.q=nj.array([[25554,10375,24475,-1484,-20289,6163,1228,-14181,-26067,-2764,-6003,-40667,2997,-13429,-24545,9497,-27924,15143,-2766,19510,12085,5661,20823,-14641,-7326,-11670,5940,28604,10195,-1528,-27336,-29118],[18183,9121,16922,9081,-25823,-19051,8592,-291,-32770,-4569,-20550,-49427,11802,-36636,-22635,4449,-33703,28512,-3423,13897,12117,3019,12033,-13619,8778,-16123,10269,18756,5127,-6802,-17256,-1931],[9186,9908,28790,16388,-11612,-33631,-3338,10157,-24921,-11617,-29551,-47178,8668,-58527,-25930,12340,-21898,37834,4242,7418,-5310,-5431,5755,-9769,15347,-19182,6184,6060,11954,-945,-4082,16419],[8900,12355,50756,13881,8753,-21111,-24410,7076,-9185,-18352,-24020,-36100,-2796,-59724,-29776,25696,-3622,35278,13309,6011,-26146,-11795,5325,-6186,6327,-17834,-1937,1688,25113,10936,399,9288],[19441,14501,64146,4044,16028,9807,-35986,-7045,560,-19537,-8231,-26363,-11383,-39716,-28896,32079,4152,23826,15565,10791,-33226,-10180,8764,-5705,-9970,-13047,-6043,9020,33153,18181,-7620,-16513],[32737,14607,58090,-3883,3013,33226,-28073,-19420,-4025,-15063,4200,-26780,-8602,-17325,-22258,25526,-5798,14525,9058,17023,-22027,-2112,10627,-8302,-18510,-8883,-1825,20545,29255,14381,-20472,-36984],[37937,12748,39502,-2400,-18818,29837,-8502,-18724,-18079,-10039,2826,-36699,3520,-13393,-14046,12034,-24308,16322,-114,18485,-4807,4869,7028,-11121,-11359,-8766,7324,24768,17495,3263,-26065,-33004],[31373,10747,26706,7357,-29865,4652,4271,-5501,-28019,-10088,-10036,-46609,14291,-31623,-9831,4047,-34248,27836,-3410,13189,685,4139,-762,-11104,5018,-12339,13417,16795,9092,-4733,-19007,-7915],[19922,10494,32578,16660,-20416,-17626,-1858,8335,-24033,-16168,-21449,-46888,14188,-55168,-11469,9015,-26272,38622,2302,5219,-12447,-3915,-7463,-7810,15704,-15794,11214,2835,12086,-2060,-5561,15548],[14676,12208,52696,17211,431,-15328,-21513,10451,-9111,-23682,-19758,-36650,3607,-62126,-15415,22547,-7416,38770,11860,982,-33892,-12249,-8622,-3822,11038,-15382,3036,-5494,23944,9002,2108,16156],[20740,14237,69394,8770,13135,10245,-36778,-570,3700,-26697,-5321,-24569,-7499,-45674,-16005,32443,5373,28020,16554,3328,-45587,-13636,-4687,-2381,-4504,-10861,-3374,-1836,33887,18436,-2885,-6300],[32535,14576,67997,-624,5684,36012,-33669,-13929,3280,-23392,9810,-20910,-8772,-20350,-10681,29915,812,15995,12135,8941,-38309,-7304,-583,-4410,-16424,-5727,-1971,9071,32795,17699,-15816,-30822],[38929,12712,50302,-2047,-15359,38326,-14992,-16548,-9343,-17720,12956,-28097,1029,-8690,-2365,17659,-16347,13359,2717,11400,-20137,357,-1166,-7667,-13538,-4006,6031,15767,21594,7576,-24694,-34512],[33476,10097,32924,6103,-30885,14717,2237,-5100,-21948,-15771,2455,-38497,12889,-20516,3206,7377,-29693,22014,-3007,7092,-9007,1678,-6750,-8816,1741,-6558,13274,10616,10403,-2545,-21293,-13629],[20347,8817,32012,16634,-26806,-13836,2432,10923,-22363,-20162,-10822,-41443,15829,-43915,2740,9014,-26247,33356,246,-1446,-16211,-5236,-12808,-6493,15618,-10293,13021,-3155,9232,-3301,-8709,12966],[10507,9673,48404,20168,-7003,-22184,-14235,17926,-9661,-27626,-13479,-33055,7000,-56203,-1608,21610,-8403,36189,9486,-7852,-35998,-14751,-14127,-2568,15596,-11022,5350,-14412,18781,6035,1483,21150]]);

  this.action_weight=nj.array([[10773,-2294,16711,2426,26330,17838,4005,19523,7365,2138,4062,17866,-3981,16820,5668,4495]]).T;

  this.action_bias=-2327/this.factor;
  this.action_weight = nj.divide(this.action_weight, this.factor);
  this.proj_k_weight = nj.divide(this.proj_k_weight, this.factor);
  this.q = nj.divide(this.q, this.factor);
}
CartpoleSwingupModel.prototype.zero_state = function() {
  return this.lstm.zero_state();
};
CartpoleSwingupModel.prototype.forward = function(x, hidden_state) {
  [h, c] = hidden_state;
  [h, c] = this.lstm.forward(x, h, c);
  k = nj.dot(h, this.proj_k_weight);
  a = nj.dot(this.q, k.T);
  w = nj.tanh(a);
  y = x.T.slice([0, 1]).flatten();
  y = nj.tanh(nj.dot(w, y));
  action = nj.tanh(nj.add(nj.dot(y, this.action_weight), this.action_bias));
  new_hidden_state = [h, c];
  return [action.tolist()[0], new_hidden_state];
}
